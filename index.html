<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mintake</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stats-display {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .main-content {
            padding: 30px;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            font-size: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .results {
            margin-top: 20px;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .food-item:hover {
            border-color: #4facfe;
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.1);
        }

        .food-info h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .food-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .calories {
            font-weight: bold;
            color: #4facfe;
            font-size: 1.1rem;
        }

        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-header h2 {
            color: #333;
        }

        .reset-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            transform: scale(1.05);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            color: #333;
        }

        .history-item strong {
            color: #222;
            font-weight: 600;
        }

        .history-item small {
            color: #666;
            font-size: 0.85rem;
        }

        .remove-btn {
            background: #ff6b6b;
            border: none;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .confirmation-modal, .input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-dialog, .input-dialog {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }

        .input-dialog input {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin: 15px 0;
            outline: none;
            text-align: center;
        }

        .input-dialog input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .confirmation-dialog h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .confirmation-dialog p, .input-dialog p {
            margin-bottom: 25px;
            color: #666;
            line-height: 1.4;
        }

        .input-dialog h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn, .cancel-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
        }

        .confirm-btn:hover {
            transform: scale(1.05);
        }

        .cancel-btn {
            background: #f0f0f0;
            color: #666;
        }

        .cancel-btn:hover {
            background: #e0e0e0;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .stats-display {
                gap: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçé Mintake</h1>
            <div class="stats-display">
                <div class="stat-item">
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">Calories</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalProtein">0g</div>
                    <div class="stat-label">Protein</div>
                </div>
            </div>
            <p>Track your daily intake</p>
        </div>

        <!-- Food not found confirmation modal -->
        <div id="foodNotFoundModal" class="confirmation-modal" style="display: none;">
            <div class="confirmation-dialog">
                <h3>Food Not Found</h3>
                <p>"<strong id="notFoundFoodName"></strong>" was not found in our database.</p>
                <p><strong>Available foods:</strong> apple, banana, chicken breast, salmon, rice, pasta, pizza, salad, eggs, milk, bread, and many more...</p>
                <div class="confirmation-buttons">
                    <button class="cancel-btn" onclick="hideFoodNotFoundModal()">Cancel</button>
                    <button class="confirm-btn" onclick="confirmManualEntry()">Add Manually</button>
                </div>
            </div>
        </div>

        <!-- Custom input modal -->
        <div id="inputModal" class="input-modal" style="display: none;">
            <div class="input-dialog">
                <h3>Add Food Manually</h3>
                <p>Enter information for your food:</p>
                <input type="text" id="foodNameInput" placeholder="Food name (e.g., Homemade Pizza)" maxlength="100">
                <input type="number" id="calorieInput" placeholder="Calories (e.g., 150)" min="1" max="9999">
                <input type="number" id="proteinInput" placeholder="Protein in grams (e.g., 20)" min="0" max="999" step="0.1">
                <div class="confirmation-buttons">
                    <button class="cancel-btn" onclick="hideInputModal()">Cancel</button>
                    <button class="confirm-btn" onclick="confirmAddFood()">Add Food</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="search-section">
                <div class="search-container">
                    <input 
                        type="text" 
                        id="foodSearch" 
                        class="search-input" 
                        placeholder="Search for food (e.g., banana, chicken breast)"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button class="search-btn" onclick="searchFood()">üîç</button>
                </div>
                
                <div id="loading" class="loading" style="display: none;">
                    Searching for food...
                </div>
                
                <div id="results" class="results"></div>
            </div>

            <div class="history-section">
                <div class="history-header">
                    <h2>Today's Foods</h2>
                    <button class="reset-btn" onclick="resetCalories(); return false;">Reset Day</button>
                </div>
                <div id="history"></div>
            </div>
        </div>

        <!-- Custom confirmation modal -->
        <div id="confirmationModal" class="confirmation-modal" style="display: none;">
            <div class="confirmation-dialog">
                <h3>Reset Your Day?</h3>
                <p>This will clear all foods and set your calorie count back to 0. This action cannot be undone.</p>
                <div class="confirmation-buttons">
                    <button class="cancel-btn" onclick="hideConfirmation()">Cancel</button>
                    <button class="confirm-btn" onclick="confirmReset()">Reset Day</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let totalCalories = 0;
        let totalProtein = 0;
        let foodHistory = [];
        let pendingSearchQuery = ''; // Store the search query for not found modal

        // Built-in food database for offline use

        // Load saved data
        function loadData() {
            const saved = JSON.parse(localStorage.getItem('intakeTracker') || '{}');
            totalCalories = saved.totalCalories || 0;
            totalProtein = saved.totalProtein || 0;
            foodHistory = saved.foodHistory || [];
            updateDisplay();
            updateHistory();
        }

        // Save data
        function saveData() {
            localStorage.setItem('intakeTracker', JSON.stringify({
                totalCalories,
                totalProtein,
                foodHistory
            }));
        }

        // Update displays
        function updateDisplay() {
            document.getElementById('totalCalories').textContent = `${totalCalories}`;
            document.getElementById('totalProtein').textContent = `${totalProtein}g`;
        }

        // Update history display
        function updateHistory() {
            const historyDiv = document.getElementById('history');
            if (foodHistory.length === 0) {
                historyDiv.innerHTML = '<div class="no-results">No foods added yet</div>';
                return;
            }

            historyDiv.innerHTML = foodHistory.map((item, index) => `
                <div class="history-item">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>${item.calories} cal ‚Ä¢ ${item.protein}g protein</small>
                    </div>
                    <button class="remove-btn" onclick="removeFood(${index})">√ó</button>
                </div>
            `).join('');
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchFood();
            }
        }

        // Built-in food database for offline use (calories per 100g, protein per 100g)
        const foodDatabase = {
            // Fruits (calories, protein)
            'apple': [52, 0.3], 'banana': [89, 1.1], 'orange': [47, 0.9], 'grapes': [62, 0.6], 'strawberry': [32, 0.7],
            'blueberry': [57, 0.7], 'watermelon': [30, 0.6], 'pineapple': [50, 0.5], 'mango': [60, 0.8], 'peach': [39, 0.9],
            
            // Vegetables (calories, protein)
            'broccoli': [25, 2.6], 'carrot': [41, 0.9], 'spinach': [23, 2.9], 'tomato': [18, 0.9], 'cucumber': [16, 0.7],
            'lettuce': [15, 1.4], 'onion': [40, 1.1], 'potato': [77, 2.0], 'sweet potato': [86, 1.6], 'corn': [86, 3.3],
            
            // Proteins (calories, protein)
            'chicken breast': [165, 31.0], 'salmon': [208, 25.4], 'tuna': [144, 30.0], 'beef': [250, 26.0], 'pork': [242, 27.3],
            'turkey': [135, 30.1], 'shrimp': [85, 20.1], 'egg': [155, 13.0], 'tofu': [76, 8.1], 'beans': [127, 8.7],
            
            // Grains & Carbs (calories, protein)
            'rice': [130, 2.7], 'pasta': [131, 5.0], 'bread': [265, 9.0], 'oats': [389, 16.9], 'quinoa': [120, 4.4],
            'cereal': [379, 8.0], 'bagel': [245, 10.0], 'tortilla': [218, 6.0], 'crackers': [502, 8.0],
            
            // Dairy (calories, protein)
            'milk': [42, 3.4], 'cheese': [402, 25.0], 'yogurt': [59, 10.0], 'butter': [717, 0.9], 'cream': [345, 2.8],
            
            // Nuts & Seeds (calories, protein)
            'almonds': [579, 21.2], 'peanuts': [567, 25.8], 'walnuts': [654, 15.2], 'cashews': [553, 15.3],
            
            // Common Foods (calories, protein)
            'pizza': [266, 11.0], 'burger': [354, 17.0], 'fries': [365, 4.0], 'sandwich': [250, 12.0], 'salad': [33, 3.0],
            'soup': [36, 1.9], 'pasta sauce': [29, 1.0], 'olive oil': [884, 0.0], 'sugar': [387, 0.0], 'honey': [304, 0.3]
        };

        // Search for food using multiple sources
        async function searchFood() {
            const query = document.getElementById('foodSearch').value.trim().toLowerCase();
            if (!query) return;

            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            // First, search built-in database
            const localResults = searchLocalDatabase(query);
            
            if (localResults.length > 0) {
                displayResults(localResults);
                loadingDiv.style.display = 'none';
                return;
            }

            // If no local results, show popup for manual entry
            loadingDiv.style.display = 'none';
            showManualEntryConfirmation(query);
        }

        // Search local database
        function searchLocalDatabase(query) {
            const results = [];
            
            // Exact matches first
            for (const [food, nutritionData] of Object.entries(foodDatabase)) {
                if (food === query) {
                    results.unshift({
                        description: food.charAt(0).toUpperCase() + food.slice(1),
                        calories: nutritionData[0],
                        protein: nutritionData[1],
                        source: 'Built-in Database'
                    });
                }
            }
            
            // Partial matches
            for (const [food, nutritionData] of Object.entries(foodDatabase)) {
                if (food.includes(query) && food !== query) {
                    results.push({
                        description: food.charAt(0).toUpperCase() + food.slice(1),
                        calories: nutritionData[0],
                        protein: nutritionData[1],
                        source: 'Built-in Database'
                    });
                }
            }
            
            return results.slice(0, 8);
        }

        // Handle Open Food Facts API results
        function displayOpenFoodFactsResults(products) {
            const resultsDiv = document.getElementById('results');
            
            const validProducts = products.filter(p => 
                p.product_name && 
                p.nutriments && 
                p.nutriments['energy-kcal_100g']
            ).slice(0, 8);

            if (validProducts.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No nutritional data available for these products.</div>';
                return;
            }

            resultsDiv.innerHTML = validProducts.map(product => {
                const calories = Math.round(product.nutriments['energy-kcal_100g'] || 0);
                const name = product.product_name;
                const brand = product.brands || 'Unknown Brand';

                return `
                    <div class="food-item" onclick="addFood('${name}', ${calories})">
                        <div class="food-info">
                            <h3>${name}</h3>
                            <p>${brand} ‚Ä¢ per 100g</p>
                        </div>
                        <div class="calories">${calories} cal/100g</div>
                    </div>
                `;
            }).join('');
        }

        // Display search results (unified for all sources)
        function displayResults(foods) {
            const resultsDiv = document.getElementById('results');
            
            if (foods.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No foods found. Try a different search term.</div>';
                return;
            }

            resultsDiv.innerHTML = foods.map(food => {
                // Handle different result formats
                let calories = 0;
                let protein = 0;
                let name = '';
                let source = '';

                if (food.calories && food.protein !== undefined) {
                    // Built-in database format
                    calories = food.calories;
                    protein = food.protein;
                    name = food.description;
                    source = food.source;
                } else if (food.foodNutrients) {
                    // USDA API format
                    const calorieNutrient = food.foodNutrients.find(n => 
                        n.nutrientName && n.nutrientName.toLowerCase().includes('energy') ||
                        n.nutrientId === 1008
                    );
                    const proteinNutrient = food.foodNutrients.find(n =>
                        n.nutrientName && n.nutrientName.toLowerCase().includes('protein') ||
                        n.nutrientId === 1003
                    );
                    calories = calorieNutrient ? Math.round(calorieNutrient.value) : 0;
                    protein = proteinNutrient ? Math.round(proteinNutrient.value * 10) / 10 : 0;
                    name = food.description;
                    source = food.brandOwner || food.dataType || 'USDA';
                }

                return `
                    <div class="food-item" onclick="addFood('${name}', ${calories}, ${protein})">
                        <div class="food-info">
                            <h3>${name}</h3>
                            <p>${source}</p>
                        </div>
                        <div class="calories">${calories} cal<br><small>${protein}g protein</small></div>
                    </div>
                `;
            }).join('');
        }

        // Add food to tracker (simplified since manual entry now handles validation)
        function addFood(name, calories, protein = 0) {
            console.log('Adding food via addFood:', name, calories, protein);
            
            const foodItem = {
                name: name,
                calories: calories,
                protein: protein,
                timestamp: new Date().toLocaleTimeString()
            };

            foodHistory.push(foodItem);
            totalCalories += calories;
            totalProtein += protein;
            
            updateDisplay();
            updateHistory();
            saveData();

            // Clear search
            document.getElementById('foodSearch').value = '';
            document.getElementById('results').innerHTML = '';
            
            // Show success message briefly
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="no-results" style="color: #4facfe; font-weight: bold;">‚úÖ Added ${name} (${calories} cal, ${protein}g protein)</div>`;
            setTimeout(() => {
                resultsDiv.innerHTML = '';
            }, 2000);
        }

        // Show food not found confirmation modal
        function showManualEntryConfirmation(query) {
            pendingSearchQuery = query;
            document.getElementById('notFoundFoodName').textContent = query;
            document.getElementById('foodNotFoundModal').style.display = 'flex';
            document.getElementById('results').innerHTML = '';
        }

        // Hide food not found modal
        function hideFoodNotFoundModal() {
            document.getElementById('foodNotFoundModal').style.display = 'none';
            pendingSearchQuery = '';
        }

        // Confirm manual entry from not found modal
        function confirmManualEntry() {
            const searchQuery = pendingSearchQuery; // Store before hiding modal
            hideFoodNotFoundModal();
            addManualFood(searchQuery);
        }

        // Show manual food entry modal
        function addManualFood(name) {
            console.log('Manual food entry for:', name);
            const formattedName = name.charAt(0).toUpperCase() + name.slice(1);
            document.getElementById('foodNameInput').value = formattedName;
            document.getElementById('calorieInput').value = '';
            document.getElementById('proteinInput').value = '';
            document.getElementById('inputModal').style.display = 'flex';
            
            // Focus on food name input after a short delay
            setTimeout(() => {
                document.getElementById('foodNameInput').focus();
                document.getElementById('foodNameInput').select();
            }, 100);
        }

        // Hide input modal
        function hideInputModal() {
            document.getElementById('inputModal').style.display = 'none';
        }

        // Confirm and add the food
        function confirmAddFood() {
            const foodNameInput = document.getElementById('foodNameInput');
            const calorieInput = document.getElementById('calorieInput');
            const proteinInput = document.getElementById('proteinInput');
            const foodName = foodNameInput.value.trim();
            const calories = parseInt(calorieInput.value);
            const protein = parseFloat(proteinInput.value) || 0;
            
            if (!foodName) {
                alert('Please enter a food name.');
                foodNameInput.focus();
                return;
            }
            
            if (!calories || calories <= 0) {
                alert('Please enter a valid number of calories (greater than 0).');
                calorieInput.focus();
                return;
            }
            
            if (calories > 9999) {
                alert('Please enter a reasonable number of calories (less than 10,000).');
                calorieInput.focus();
                return;
            }
            
            if (protein < 0 || protein > 999) {
                alert('Please enter a valid protein amount (0-999g).');
                proteinInput.focus();
                return;
            }
            
            console.log('Adding food:', foodName, calories, protein);
            
            // Add the food
            const foodItem = {
                name: foodName,
                calories: calories,
                protein: protein,
                timestamp: new Date().toLocaleTimeString()
            };

            foodHistory.push(foodItem);
            totalCalories += calories;
            totalProtein += protein;
            
            updateDisplay();
            updateHistory();
            saveData();

            // Clear search and hide modal
            document.getElementById('foodSearch').value = '';
            document.getElementById('results').innerHTML = '';
            hideInputModal();
            
            // Show success message
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="no-results" style="color: #4facfe; font-weight: bold;">‚úÖ Added ${foodName} (${calories} cal, ${protein}g protein)</div>`;
            setTimeout(() => {
                resultsDiv.innerHTML = '';
            }, 2000);
        }

        // Remove food from history
        function removeFood(index) {
            const removedFood = foodHistory[index];
            totalCalories -= removedFood.calories;
            totalProtein -= removedFood.protein;
            foodHistory.splice(index, 1);
            
            updateDisplay();
            updateHistory();
            saveData();
        }

        // Show custom confirmation dialog
        function resetCalories() {
            console.log('Reset button clicked');
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        // Hide confirmation dialog
        function hideConfirmation() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        // Confirm and execute reset
        function confirmReset() {
            console.log('Reset confirmed');
            
            totalCalories = 0;
            totalProtein = 0;
            foodHistory = [];
            
            updateDisplay();
            updateHistory();
            saveData();
            
            // Clear any search results
            document.getElementById('foodSearch').value = '';
            document.getElementById('results').innerHTML = '';
            
            // Hide modal
            hideConfirmation();
            
            // Show success message
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '<div class="no-results" style="color: #4facfe; font-weight: bold;">‚úÖ Day reset successfully!</div>';
            setTimeout(() => {
                updateHistory();
            }, 1500);
            
            console.log('Reset complete');
        }

        // Initialize app
        loadData();
    </script>
</body>
</html>